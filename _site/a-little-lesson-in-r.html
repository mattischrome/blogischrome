<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="A Little Lesson in R" /><meta name="author" content="Matthew Dorey" /><meta property="og:locale" content="en_US" /><meta name="description" content="I had to compute an indicator this week. It had confidence intervals that relied on taking 100,000 samples from the indicator’s approximate distribution. I had to repeat this over multiple GP practices and for twelve different demographic groups." /><meta property="og:description" content="I had to compute an indicator this week. It had confidence intervals that relied on taking 100,000 samples from the indicator’s approximate distribution. I had to repeat this over multiple GP practices and for twelve different demographic groups." /><link rel="canonical" href="http://localhost:4000/a-little-lesson-in-r" /><meta property="og:url" content="http://localhost:4000/a-little-lesson-in-r" /><meta property="og:site_name" content="Mattischrome" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-11-04T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="A Little Lesson in R" /><meta name="twitter:site" content="@mattischrome" /><meta name="twitter:creator" content="@mattischrome" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/a-little-lesson-in-r"},"url":"http://localhost:4000/a-little-lesson-in-r","headline":"A Little Lesson in R","dateModified":"2017-11-04T00:00:00+00:00","datePublished":"2017-11-04T00:00:00+00:00","author":{"@type":"Person","name":"Matthew Dorey"},"description":"I had to compute an indicator this week. It had confidence intervals that relied on taking 100,000 samples from the indicator’s approximate distribution. I had to repeat this over multiple GP practices and for twelve different demographic groups.","@type":"BlogPosting","@context":"https://schema.org"}</script><title> A Little Lesson in R - Mattischrome</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="Mattischrome" href="/atom.xml"><link rel="alternate" type="application/json" title="Mattischrome" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.post-nav{display:flex;justify-content:space-between;flex-wrap:wrap}.post-nav p{flex:1 1 0;width:45%}.post-nav p:first-child{padding-right:0.5em}.post-nav p:last-child{padding-left:0.5em;text-align:right}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">Mattischrome</h1>--><nav role="navigation"><ul><li><a href="/" >mattischrome</a></li><li><a href="/about" >About</a></li><li><a href="/search" >Search</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h2>A Little Lesson in R</h2><p>I had to compute an indicator this week. It had confidence intervals that relied on taking 100,000 samples from the indicator’s approximate distribution. I had to repeat this over multiple GP practices and for twelve different demographic groups.</p><p>I decided to use <code>dplyr</code><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup> because I thought it would help me organise all subgroups involved. I used <a href="http://dplyr.tidyverse.org/reference/summarise_all.html"><code>mutate_at()</code></a> heavily and thought that <code>dplyr</code> was keeping everything organised. However, when I moved from the 10 samples I’d used for testing to the 100,000 samples required by the specification of the indicator, my code moved to a crawl. Fearing that my work laptop was a little puny, I left it running overnight on my Mac<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup> and by morning R was still holding up its infuriating little stop sign.</p><p>So how could I fix it? The programmer in me returned to the for loops that I’d tried to avoid. I overhauled the code using base R and vectorised <code>sapply</code> commands. These were handy, cutting out some of the loops, though I still used a loop for each of the sites. This is not an unfamiliar approach for me: I used the same technique to run my <a href="swaptastic-part-2">sticker swapping simulations</a> last year. The original <code>dplyr</code> commands aren’t designed for passing around so many numbers about, at least not in this particular way<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>.</p><p>In the end most of the work was done by this single line of code:</p><pre><code class="language-r">sapply(sapply(rep(1,num_samples), 
               runif),
        qnorm,
        sample_mean,
        sample_sd)
</code></pre><p>It looks complicated but can be unpacked as follows: <code>sapply</code> takes a vector and a function, applying the function to each element of the vector. The first, inner, call to <code>sapply</code> constructs the vector for the second, outer, call. The vector constructed consists of uniformly generated random numbers between 0 and 1 (using <code>runif</code>). The second <code>sapply</code> calls <code>qnorm</code>,<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote">4</a></sup> which is R’s approximation to the inverse cumulative distribution function of the normal distribution. The additional parameters to the second <code>sapply</code> are the parameters required by <code>qnorm</code>.</p><p>The new code ran on my work laptop and took just over four minutes to finish. This is what stunned me into writing this post. Even though both bits of code had taken a similar amount of time to run in the test case, the time invested in writing things properly is well worth the extra effort.</p><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p>There will be future posts about <code>dplyr</code>. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p></li><li id="fn:2" role="doc-endnote"><p>This indicator involved the use of publicly available data so I was free to use the code at home. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p></li><li id="fn:3" role="doc-endnote"><p>That said, at the time of writing there is &lt;a href="https://github.com/tidyverse/dplyr/issues/2813"&gt;an open github issue&lt;/a&gt; about the slowness of <code>mutate_at()</code> in the current version of <code>dplyr</code>. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p></li><li id="fn:4" role="doc-endnote"><p>Various properties and generators of random numbers from various distributions are discussed in &lt;a href="https://mattischrome.com/generate-random-numbers-in-r/"&gt;this post&lt;/a&gt;. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p></li></ol></div><span class="meta"><time datetime="2017-11-04T00:00:00+00:00">November 4, 2017</time> &middot; <a href="/tag/Programming">Programming</a>, <a href="/tag/R">R</a></span><hr/><div class="post-nav"><p> <a href="/suits-me">&#8672;&nbsp;Suits Me</a></p><p> <a href="/beetroot-bolognaise">Beetroot Bolognaise&nbsp;&#8674;</a></p></div><!--<span class="meta"><time datetime="2017-11-04T00:00:00+00:00">November 4, 2017</time> &middot; <a class="post" href="/tag/Programming">Programming</a>, <a class="post" href="/tag/R">R</a></span> --></section></main></body></html>
